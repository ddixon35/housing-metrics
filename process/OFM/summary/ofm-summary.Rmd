---
title: "OFM"
output: html_document
---

View OFM April 1 data in Elmer.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(odbc)
library(DBI)
library(DT)
library(data.table)
library(ggplot2)

elmer_connection <- dbConnect(odbc::odbc(),
  driver = "SQL Server",
  server = "AWS-PROD-SQL\\Sockeye",
  database = "Elmer",
  trusted_connection = "yes"
  ) 
```

## Publications
Adjust `sql.query` below where appropriate. To view different vintages of OFM April 1 Postcensal data, check the `ofm.publication_dim` for the specific `publication_dim_id`:
```{r}
pub.dim <- dbGetQuery(elmer_connection, SQL('SELECT * FROM ofm.publication_dim'))
datatable(pub.dim)
```

## Postcensal Data
```{r}
sql.query <- 'SELECT b.county_name, b.jurisdiction_name, a.estimate_year, a.housing_units, a.total_population, a.publication_dim_id, c.publication_name, c.publication_type
FROM ofm.april_1_estimate_facts AS a 
    LEFT JOIN ofm.jurisdiction_dim AS b ON a.jurisdiction_dim_id = b.jurisdiction_dim_id
    LEFT JOIN ofm.publication_dim AS c ON a.publication_dim_id = c.publication_dim_id
WHERE a.publication_dim_id = 6;'

# read in a queried table
df <- dbGetQuery(elmer_connection, SQL(sql.query))
datatable(df)
```

```{r}
setDT(df)
df.plot <- df[, lapply(.SD, sum), .SDcols = c('total_population', 'housing_units'), by = c('county_name', 'estimate_year', 'publication_name')]

df.plot.l <- melt(df.plot, measure.vars = c('total_population', 'housing_units'))
brk <- seq(min(df.plot.l$estimate_year), max(df.plot.l$estimate_year), by = 5)

ggplot(df.plot.l) +
  geom_col(aes(estimate_year, value)) +
  facet_grid(cols = vars(county_name), rows = vars(variable), scales = 'free') +
  scale_x_continuous(labels = brk,
                     breaks = brk) +
  labs(x = NULL,
       y = NULL,
       caption = paste('Source:', unique(df.plot.l$publication_name))) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1, 
                                   vjust = 1))
```

```{r}
dbDisconnect(elmer_connection)
```

